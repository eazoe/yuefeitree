<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²³é£å®¶è°±</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
            text-align: center;
            color: #333;
        }
        
        /* --- é¡¶éƒ¨æ§åˆ¶æ  --- */
        .controls { 
            max-width: 1100px;
            margin: 0 auto 30px auto;
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
            vertical-align: middle;
        }
        .mode-view { background: #e9ecef; color: #495057; border: 1px solid #ced4da;}
        .mode-edit { background: #fff3cd; color: #856404; border: 1px solid #ffeeba;}

        .btn-group { display: flex; gap: 8px; align-items: center; }

        .btn-control {
            padding: 8px 15px; cursor: pointer;
            border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px;
            transition: 0.2s; font-size: 14px;
        }
        .btn-control:hover { background: #e2e6ea; }
        .btn-primary { background: #007bff !important; color: white !important; border-color: #007bff !important; }
        .btn-primary:hover { background: #0056b3 !important; }
        
        .admin-only { display: none; } 

        .switch-mode-btn {
            border: 1px solid #007bff; color: #007bff; background: white;
        }
        .switch-mode-btn.active {
            background: #007bff; color: white;
        }

        /* --- æ ‘çŠ¶å›¾å®¹å™¨ --- */
        .tree-wrapper {
            width: 100%;
            overflow: auto;
            padding-bottom: 100px; 
            cursor: grab;
            position: relative; 
        }
        .tree { 
            display: inline-block; 
            min-width: 100%;
            position: relative;
            z-index: 2; 
        }
        
        /* --- æ ¸å¿ƒæ ‘çŠ¶å›¾ CSS (é—´è·ä¼˜åŒ–ç‰ˆ) --- */
        .tree ul {
            /* æ¯ä¸€ä»£ä¹‹é—´çš„ä¸Šé—´è·ï¼Œä»20pxå¢åŠ åˆ°40px */
            padding-top: 40px; 
            position: relative;
            transition: all 0.5s;
            display: flex; justify-content: center;
            white-space: nowrap;
        }
        .tree li {
            float: left; text-align: center;
            list-style-type: none;
            position: relative;
            /* æ¯ä¸€ä»£ä¹‹é—´çš„èŠ‚ç‚¹é—´è·ï¼Œä»20pxå¢åŠ åˆ°40px */
            padding: 40px 5px 0 5px;
            transition: all 0.5s;
        }
        /* è¿çº¿æ ·å¼ */
        .tree li::before, .tree li::after {
            content: ''; position: absolute; top: 0; right: 50%;
            border-top: 1px solid #ccc; width: 50%; 
            /* å‚ç›´è¿æ¥çº¿é«˜åº¦ï¼Œä»20pxå¢åŠ åˆ°40px */
            height: 40px; 
        }
        .tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before{ border-right: 1px solid #ccc; border-radius: 0 5px 0 0; }
        .tree li:first-child::after{ border-radius: 5px 0 0 0; }
        
        /* å‘ä¸‹çš„è¿æ¥çº¿ */
        .tree ul ul::before{
            content: ''; position: absolute; top: 0; left: 50%;
            border-left: 1px solid #ccc; width: 0; 
            /* å‚ç›´è¿æ¥çº¿é«˜åº¦ï¼Œä»20pxå¢åŠ åˆ°40px */
            height: 40px; 
        }

        /* --- äººç‰©å¡ç‰‡ --- */
        .member-card {
            border: 1px solid #ccc;
            padding: 12px 10px;
            text-decoration: none;
            color: #666;
            background: white;
            display: inline-block;
            border-radius: 6px;
            min-width: 190px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer; 
            z-index: 2; 
            overflow: hidden; 
        }

        /* ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå¡ç‰‡åº•éƒ¨æ°¸ä¹…é¢„ç•™ç©ºé—´ */
        body.edit-mode-active .member-card {
            padding-bottom: 36px; 
            border-color: #b3d7ff;
        }

        .member-card:hover {
            background: #e3f2fd; border-color: #007bff;
            transform: scale(1.05); z-index: 10;
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        .member-card:hover + ul .member-card {
            background: #f1f8ff; border-color: #b3d7ff;
        }
        .card-name { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 6px; display: block; }
        .card-info { font-size: 11px; color: #666; margin-bottom: 0px; display: block; }

        /* --- å¡ç‰‡æ“ä½œæ¡ (å¸¸è®¾ç‰ˆ) --- */
        .card-actions-static {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            height: 32px;
            background: #f1f8ff;
            border-top: 1px solid #dae0e5;
            display: none; 
            justify-content: center;
            align-items: center;
            gap: 3px; 
            z-index: 5;
        }
        
        /* ç¼–è¾‘æ¨¡å¼ä¸‹ç›´æ¥æ˜¾ç¤º */
        body.edit-mode-active .card-actions-static {
            display: flex;
        }

        .btn-static-action {
            border: none; border-radius: 3px;
            color: white; font-size: 10px; padding: 4px 6px;
            cursor: pointer; line-height: 1;
            white-space: nowrap;
        }
        .btn-s-add { background: #28a745; }
        .btn-s-edit { background: #007bff; }
        .btn-s-del { background: #dc3545; }
        .btn-s-insert { background: #6610f2; } /* ç´«è‰²ï¼šåŠ çˆ¶è¾ˆ */
        
        .btn-static-action:hover { filter: brightness(1.1); transform: scale(1.05); }

        /* --- ä»£æ•°è¾…åŠ©å±‚ --- */
        #generation-guides {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; overflow: hidden;
        }
        /* å»æ‰äº† .gen-line (è™šçº¿)ï¼Œåªä¿ç•™æ ‡ç­¾ */
        .gen-label {
            position: absolute; left: 10px; font-size: 12px; font-weight: bold;
            color: #007bff; background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px; border-radius: 12px; border: 1px solid #e3f2fd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 5;
        }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 12px;
            width: 450px; max-width: 90%; text-align: left;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer;
        }
        .close-btn:hover { color: #333; }

        .view-header { text-align: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .view-name { font-size: 24px; font-weight: bold; color: #333; margin: 0; }
        .view-gen { font-size: 13px; color: #007bff; background: #e3f2fd; padding: 2px 8px; border-radius: 10px; display: inline-block; margin-top: 5px;}
        .view-row { margin-bottom: 10px; color: #555; font-size: 14px; display: flex; }
        .view-label { font-weight: bold; width: 90px; color: #333; flex-shrink: 0;}
        .view-content { flex-grow: 1; line-height: 1.5; white-space: pre-wrap;}
        
        .view-actions { 
            display: none; 
            margin-top: 25px; justify-content: space-between; border-top: 1px solid #eee; padding-top: 20px; gap: 10px;
        }
        .btn-action { flex: 1; border: none; padding: 10px 0; border-radius: 6px; cursor: pointer; font-size: 13px; transition: 0.2s;}
        .btn-add-child { background: #28a745; color: white; }
        .btn-add-child:hover { background: #218838; }
        .btn-edit-info { background: #007bff; color: white; }
        .btn-edit-info:hover { background: #0056b3; }
        .btn-del-mem { background: #fff; color: #dc3545; border: 1px solid #dc3545; max-width: 80px;}
        .btn-del-mem:hover { background: #ffeef0; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold; }
        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .form-group select, .form-group input, .form-group textarea { 
            width: 100%; padding: 10px; box-sizing: border-box; 
            border: 1px solid #ddd; border-radius: 6px; 
            font-family: inherit; font-size: 14px;
            background-color: #fff;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #007bff; outline: none; }
        .form-group textarea { height: 80px; resize: vertical; }
        
        .flex-row { display: flex; gap: 10px; }
        .flex-col { flex: 1; }

        .modal-buttons { text-align: right; margin-top: 20px; }
        .btn-cancel { background: #6c757d; color: white; margin-right: 10px; padding: 8px 16px; border:none; border-radius:6px; cursor:pointer;}
        .btn-save { background: #28a745; color: white; padding: 8px 16px; border:none; border-radius:6px; cursor:pointer;}
        .btn-save:hover { background: #218838; }

        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="controls">
    <div class="app-title">
        å²³é£å®¶è°± 
        <span class="mode-badge mode-view" id="modeBadge">æŸ¥çœ‹æ¨¡å¼</span>
    </div>

    <div class="btn-group">
        <button class="btn-control btn-primary admin-only" onclick="downloadData()">ğŸ’¾ å¯¼å‡ºå¤‡ä»½</button>
        <button class="btn-control admin-only" onclick="document.getElementById('fileInput').click()">ğŸ“‚ å¯¼å…¥æ–‡ä»¶</button>
        
        <button class="btn-control switch-mode-btn" onclick="toggleEditMode()" id="btnToggleMode">âš™ï¸ è¿›å…¥ç¼–è¾‘æ¨¡å¼</button>
    </div>
    <input type="file" id="fileInput" accept=".json" onchange="importData(this)">
</div>

<div class="tree-wrapper">
    <div id="generation-guides"></div>
    <div class="tree" id="family-tree-container"></div>
</div>

<!-- å¼¹çª— 1: æŸ¥çœ‹è¯¦æƒ… -->
<div id="viewModal" class="modal-overlay" onclick="closeAllModals(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closeAllModals()">Ã—</button>
        <div class="view-header">
            <div class="view-name" id="viewName">å§“å</div>
            <div class="view-gen" id="viewGen">ä»£æ•°</div>
        </div>
        <div class="view-row">
            <div class="view-label">ğŸ‚ ç”Ÿæ—¥:</div>
            <div class="view-content" id="viewBirth">-</div>
        </div>
        <div class="view-row">
            <div class="view-label">ğŸ“ ç±è´¯:</div>
            <div class="view-content" id="viewHometown">-</div>
        </div>
        <div class="view-row">
            <div class="view-label">ğŸ  å±…ä½åœ°:</div>
            <div class="view-content" id="viewResidence">-</div>
        </div>
        <div class="view-row">
            <div class="view-label">ğŸ“ ç”Ÿå¹³:</div>
            <div class="view-content" id="viewBio">æš‚æ— ä»‹ç»</div>
        </div>
        
        <div class="view-actions" id="viewActionButtons">
            <button class="btn-action btn-add-child" onclick="addMemberFromModal()">+ æ–°å¢ä¸‹çº§</button>
            <button class="btn-action btn-edit-info" onclick="switchToEditMode()">âœ ç¼–è¾‘ä¿¡æ¯</button>
            <button class="btn-action btn-del-mem" id="btnDeleteMember" onclick="handleDelete()">ğŸ—‘ åˆ é™¤</button>
        </div>
    </div>
</div>

<!-- å¼¹çª— 2: ç¼–è¾‘è¡¨å• -->
<div id="editModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0; text-align:center;" id="editModalTitle">ç¼–è¾‘æˆå‘˜ä¿¡æ¯</h3>
        <div class="form-group">
            <label>å§“åï¼š</label>
            <input type="text" id="inputName" placeholder="è¯·è¾“å…¥å§“å">
        </div>
        
        <div class="form-group">
            <label>ç¬¬å‡ ä»£ï¼š</label>
            <select id="inputGeneration"></select>
        </div>

        <div class="form-group">
            <label>å‡ºç”Ÿæ—¥æœŸï¼š</label>
            <input type="date" id="inputBirth">
        </div>

        <div class="form-group">
            <label>ç±è´¯ (ç¥–ç±)ï¼š</label>
            <div class="flex-row">
                <select class="flex-col" id="inputHomeProv" onchange="updateCityOptions('inputHomeProv', 'inputHomeCity')">
                    <option value="">çœä»½</option>
                </select>
                <select class="flex-col" id="inputHomeCity">
                    <option value="">åŸå¸‚</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>å½“å‰å±…ä½åœ°ï¼š</label>
            <div class="flex-row">
                <select class="flex-col" id="inputResProv" onchange="updateCityOptions('inputResProv', 'inputResCity')">
                    <option value="">çœä»½</option>
                </select>
                <select class="flex-col" id="inputResCity">
                    <option value="">åŸå¸‚</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>ç”Ÿå¹³/å¤‡æ³¨ï¼š</label>
            <textarea id="inputBio" placeholder="åœ¨æ­¤è¾“å…¥ç”Ÿå¹³äº‹è¿¹æˆ–å…¶ä»–å¤‡æ³¨..."></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeAllModals()">å–æ¶ˆ</button>
            <button class="btn-save" onclick="saveMemberData()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>

<script>
    const chinaCityData = {
        "åŒ—äº¬å¸‚": ["åŒ—äº¬å¸‚"], "å¤©æ´¥å¸‚": ["å¤©æ´¥å¸‚"], "ä¸Šæµ·å¸‚": ["ä¸Šæµ·å¸‚"], "é‡åº†å¸‚": ["é‡åº†å¸‚"],
        "æ²³åŒ—çœ": ["çŸ³å®¶åº„å¸‚","å”å±±å¸‚","ç§¦çš‡å²›å¸‚","é‚¯éƒ¸å¸‚","é‚¢å°å¸‚","ä¿å®šå¸‚","å¼ å®¶å£å¸‚","æ‰¿å¾·å¸‚","æ²§å·å¸‚","å»ŠåŠå¸‚","è¡¡æ°´å¸‚"],
        "å±±è¥¿çœ": ["å¤ªåŸå¸‚","å¤§åŒå¸‚","é˜³æ³‰å¸‚","é•¿æ²»å¸‚","æ™‹åŸå¸‚","æœ”å·å¸‚","æ™‹ä¸­å¸‚","è¿åŸå¸‚","å¿»å·å¸‚","ä¸´æ±¾å¸‚","å•æ¢å¸‚"],
        "æ²³å—çœ": ["éƒ‘å·å¸‚","å¼€å°å¸‚","æ´›é˜³å¸‚","å¹³é¡¶å±±å¸‚","å®‰é˜³å¸‚","é¹¤å£å¸‚","æ–°ä¹¡å¸‚","ç„¦ä½œå¸‚","æ¿®é˜³å¸‚","è®¸æ˜Œå¸‚","æ¼¯æ²³å¸‚","ä¸‰é—¨å³¡å¸‚","å—é˜³å¸‚","å•†ä¸˜å¸‚","ä¿¡é˜³å¸‚","å‘¨å£å¸‚","é©»é©¬åº—å¸‚"],
        "æ¹–åŒ—çœ": ["æ­¦æ±‰å¸‚","é»„çŸ³å¸‚","åå °å¸‚","å®œæ˜Œå¸‚","è¥„é˜³å¸‚","é„‚å·å¸‚","è†é—¨å¸‚","å­æ„Ÿå¸‚","è†å·å¸‚","é»„å†ˆå¸‚","å’¸å®å¸‚","éšå·å¸‚"],
        "æ¹–å—çœ": ["é•¿æ²™å¸‚","æ ªæ´²å¸‚","æ¹˜æ½­å¸‚","è¡¡é˜³å¸‚","é‚µé˜³å¸‚","å²³é˜³å¸‚","å¸¸å¾·å¸‚","å¼ å®¶ç•Œå¸‚","ç›Šé˜³å¸‚","éƒ´å·å¸‚","æ°¸å·å¸‚","æ€€åŒ–å¸‚","å¨„åº•å¸‚"],
        "å¹¿ä¸œçœ": ["å¹¿å·å¸‚","éŸ¶å…³å¸‚","æ·±åœ³å¸‚","ç æµ·å¸‚","æ±•å¤´å¸‚","ä½›å±±å¸‚","æ±Ÿé—¨å¸‚","æ¹›æ±Ÿå¸‚","èŒ‚åå¸‚","è‚‡åº†å¸‚","æƒ å·å¸‚","æ¢…å·å¸‚","æ±•å°¾å¸‚","æ²³æºå¸‚","é˜³æ±Ÿå¸‚","æ¸…è¿œå¸‚","ä¸œèå¸‚","ä¸­å±±å¸‚","æ½®å·å¸‚","æ­é˜³å¸‚","äº‘æµ®å¸‚"],
        "æ±Ÿè‹çœ": ["å—äº¬å¸‚","æ— é”¡å¸‚","å¾å·å¸‚","å¸¸å·å¸‚","è‹å·å¸‚","å—é€šå¸‚","è¿äº‘æ¸¯å¸‚","æ·®å®‰å¸‚","ç›åŸå¸‚","æ‰¬å·å¸‚","é•‡æ±Ÿå¸‚","æ³°å·å¸‚","å®¿è¿å¸‚"],
        "æµ™æ±Ÿçœ": ["æ­å·å¸‚","å®æ³¢å¸‚","æ¸©å·å¸‚","å˜‰å…´å¸‚","æ¹–å·å¸‚","ç»å…´å¸‚","é‡‘åå¸‚","è¡¢å·å¸‚","èˆŸå±±å¸‚","å°å·å¸‚","ä¸½æ°´å¸‚"],
        "å®‰å¾½çœ": ["åˆè‚¥å¸‚","èŠœæ¹–å¸‚","èšŒåŸ å¸‚","æ·®å—å¸‚","é©¬éå±±å¸‚","æ·®åŒ—å¸‚","é“œé™µå¸‚","å®‰åº†å¸‚","é»„å±±å¸‚","æ»å·å¸‚","é˜œé˜³å¸‚","å®¿å·å¸‚","å…­å®‰å¸‚","äº³å·å¸‚","æ± å·å¸‚","å®£åŸå¸‚"],
        "ç¦å»ºçœ": ["ç¦å·å¸‚","å¦é—¨å¸‚","è†ç”°å¸‚","ä¸‰æ˜å¸‚","æ³‰å·å¸‚","æ¼³å·å¸‚","å—å¹³å¸‚","é¾™å²©å¸‚","å®å¾·å¸‚"],
        "æ±Ÿè¥¿çœ": ["å—æ˜Œå¸‚","æ™¯å¾·é•‡å¸‚","èä¹¡å¸‚","ä¹æ±Ÿå¸‚","æ–°ä½™å¸‚","é¹°æ½­å¸‚","èµ£å·å¸‚","å‰å®‰å¸‚","å®œæ˜¥å¸‚","æŠšå·å¸‚","ä¸Šé¥¶å¸‚"],
        "å±±ä¸œçœ": ["æµå—å¸‚","é’å²›å¸‚","æ·„åšå¸‚","æ£åº„å¸‚","ä¸œè¥å¸‚","çƒŸå°å¸‚","æ½åŠå¸‚","æµå®å¸‚","æ³°å®‰å¸‚","å¨æµ·å¸‚","æ—¥ç…§å¸‚","ä¸´æ²‚å¸‚","å¾·å·å¸‚","èŠåŸå¸‚","æ»¨å·å¸‚","èæ³½å¸‚"],
        "å››å·çœ": ["æˆéƒ½å¸‚","è‡ªè´¡å¸‚","æ”€æèŠ±å¸‚","æ³¸å·å¸‚","å¾·é˜³å¸‚","ç»µé˜³å¸‚","å¹¿å…ƒå¸‚","é‚å®å¸‚","å†…æ±Ÿå¸‚","ä¹å±±å¸‚","å—å……å¸‚","çœ‰å±±å¸‚","å®œå®¾å¸‚","å¹¿å®‰å¸‚","è¾¾å·å¸‚","é›…å®‰å¸‚","å·´ä¸­å¸‚","èµ„é˜³å¸‚"],
        "é™•è¥¿çœ": ["è¥¿å®‰å¸‚","é“œå·å¸‚","å®é¸¡å¸‚","å’¸é˜³å¸‚","æ¸­å—å¸‚","å»¶å®‰å¸‚","æ±‰ä¸­å¸‚","æ¦†æ—å¸‚","å®‰åº·å¸‚","å•†æ´›å¸‚"],
        "å…¶ä»–": ["å…¶ä»–"]
    };

    const STORAGE_KEY = 'yuefei_family_tree_v18'; 
    let familyData = {};
    let nextId = 100;
    let currentActiveId = null; 
    let isAddingNew = false;
    let isInsertingParent = false; 
    let isEditMode = false; 

    const defaultData = {
        id: 1, name: "å²³é£", generation: "ç¬¬1ä»£", birthDate: "1103-03-24",
        hometownProv: "æ²³å—çœ", hometownCity: "å®‰é˜³å¸‚", 
        residenceProv: "", residenceCity: "",
        bio: "å­—é¹ä¸¾ï¼Œå®‹ç›¸å·æ±¤é˜´å¿äººã€‚å—å®‹æŠ—é‡‘åå°†ã€‚",
        children: [
            { 
                id: 2, name: "å²³äº‘", generation: "ç¬¬2ä»£", birthDate: "1119-01-01", bio: "å²³é£é•¿å­ï¼Œä¸çˆ¶ä¸€åŒé‡å®³ã€‚", 
                children: [
                    { id: 101, name: "å²³ç”«", generation: "ç¬¬3ä»£", birthDate: "", children: [] },
                    { id: 102, name: "å²³ç”³", generation: "ç¬¬3ä»£", birthDate: "", children: [] }
                ] 
            },
            { 
                id: 3, name: "å²³é›·", generation: "ç¬¬2ä»£", birthDate: "", bio: "å²³é£æ¬¡å­ã€‚", children: [] 
            }
        ]
    };

    function initData() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                familyData = parsed.data;
                nextId = parsed.nextId;
            } catch (e) {
                familyData = JSON.parse(JSON.stringify(defaultData));
            }
        } else {
            familyData = JSON.parse(JSON.stringify(defaultData));
        }
        initDropdowns(); 
        refreshView();
        updateModeUI();
    }

    function initDropdowns() {
        const genSelect = document.getElementById('inputGeneration');
        genSelect.innerHTML = '';
        for (let i = 1; i <= 50; i++) {
            let opt = document.createElement('option');
            opt.value = `ç¬¬${i}ä»£`;
            opt.innerText = `ç¬¬${i}ä»£`;
            genSelect.appendChild(opt);
        }
        populateProvince('inputHomeProv');
        populateProvince('inputResProv');
    }

    function populateProvince(selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">è¯·é€‰æ‹©çœä»½</option>';
        for (let prov in chinaCityData) {
            let opt = document.createElement('option');
            opt.value = prov;
            opt.innerText = prov;
            select.appendChild(opt);
        }
    }

    window.updateCityOptions = function(provSelectId, citySelectId, selectedCity = null) {
        const provSelect = document.getElementById(provSelectId);
        const citySelect = document.getElementById(citySelectId);
        const prov = provSelect.value;
        citySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åŸå¸‚</option>';
        if (prov && chinaCityData[prov]) {
            chinaCityData[prov].forEach(city => {
                let opt = document.createElement('option');
                opt.value = city;
                opt.innerText = city;
                citySelect.appendChild(opt);
            });
        }
        if (selectedCity) citySelect.value = selectedCity;
    };

    function saveToLocal() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ data: familyData, nextId: nextId }));
    }

    window.toggleEditMode = function() {
        isEditMode = !isEditMode;
        updateModeUI();
    };

    function updateModeUI() {
        const badge = document.getElementById('modeBadge');
        const btn = document.getElementById('btnToggleMode');
        const adminBtns = document.querySelectorAll('.admin-only');

        if (isEditMode) {
            badge.innerText = "ç¼–è¾‘æ¨¡å¼"; badge.className = "mode-badge mode-edit";
            btn.innerText = "ğŸ‘ é€€å‡ºç¼–è¾‘æ¨¡å¼"; btn.className = "btn-control switch-mode-btn active";
            adminBtns.forEach(el => el.style.display = 'block');
            document.body.classList.add('edit-mode-active');
        } else {
            badge.innerText = "æŸ¥çœ‹æ¨¡å¼"; badge.className = "mode-badge mode-view";
            btn.innerText = "âš™ï¸ è¿›å…¥ç¼–è¾‘æ¨¡å¼"; btn.className = "btn-control switch-mode-btn";
            adminBtns.forEach(el => el.style.display = 'none');
            document.body.classList.remove('edit-mode-active');
        }
        setTimeout(drawGenerationGuides, 100);
    }

    function formatDateCN(dateStr) {
        if (!dateStr) return "";
        const parts = dateStr.split('-');
        if (parts.length !== 3) return dateStr;
        return `å‡ºç”Ÿæ—¥æœŸï¼š${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥`;
    }

    function renderTreeHTML(node, depth = 1) {
        if (!node) return '';
        
        let birthInfo = formatDateCN(node.birthDate);
        let deleteBtn = node.id === familyData.id ? '' : `<button class="btn-static-action btn-s-del" onclick="event.stopPropagation(); quickDelete(${node.id})">åˆ é™¤</button>`;
        
        // æ’å…¥çˆ¶è¾ˆæŒ‰é’®ï¼šä»…åœ¨æ·±åº¦>2æ˜¾ç¤º
        let insertParentBtn = '';
        if (depth > 2) {
            insertParentBtn = `<button class="btn-static-action btn-s-insert" title="åœ¨æ­¤äººä¸çˆ¶äº²ä¹‹é—´æ’å…¥ä¸€ä»£" onclick="event.stopPropagation(); quickInsertParent(${node.id})">åŠ çˆ¶è¾ˆ</button>`;
        }

        let html = `
            <li>
                <div class="member-card" data-depth="${depth}" onclick="openViewModal(${node.id})">
                    <span class="card-name">${node.name}</span>
                    <span class="card-gen" style="display:none;">${node.generation}</span>
                    <span class="card-info" style="font-size:10px;">${birthInfo}</span>
                    
                    <div class="card-actions-static">
                        ${insertParentBtn}
                        <button class="btn-static-action btn-s-add" onclick="event.stopPropagation(); quickAdd(${node.id})">æ–°å¢</button>
                        <button class="btn-static-action btn-s-edit" onclick="event.stopPropagation(); quickEdit(${node.id})">ç¼–è¾‘</button>
                        ${deleteBtn}
                    </div>
                </div>
        `;

        if (node.children && node.children.length > 0) {
            html += '<ul>';
            node.children.forEach(child => {
                html += renderTreeHTML(child, depth + 1);
            });
            html += '</ul>';
        }
        html += `</li>`;
        return html;
    }

    function refreshView() {
        document.getElementById('family-tree-container').innerHTML = '<ul>' + renderTreeHTML(familyData) + '</ul>';
        setTimeout(drawGenerationGuides, 50); 
    }

    function findParent(root, childId) {
        if (!root.children) return null;
        for (let child of root.children) {
            if (child.id === childId) return root;
            let found = findParent(child, childId);
            if (found) return found;
        }
        return null;
    }

    function findNode(root, id) {
        if (root.id === id) return root;
        if (root.children) {
            for (let child of root.children) {
                let found = findNode(child, id);
                if (found) return found;
            }
        }
        return null;
    }

    // --- å¿«é€Ÿæ“ä½œ ---
    window.quickAdd = function(id) { currentActiveId = id; addMemberFromModal(); };
    window.quickEdit = function(id) { currentActiveId = id; switchToEditMode(); };
    window.quickDelete = function(id) { currentActiveId = id; handleDelete(); };
    
    window.quickInsertParent = function(id) {
        currentActiveId = id;
        isInsertingParent = true; 
        isAddingNew = false;
        
        document.getElementById('viewModal').style.display = 'none';
        document.getElementById('editModalTitle').innerText = "æ’å…¥ä¸Šä¸€ä»£ (çˆ¶è¾ˆ)";
        
        document.getElementById('inputName').value = "";
        document.getElementById('inputBirth').value = "";
        document.getElementById('inputBio').value = "";
        document.getElementById('inputHomeProv').value = "";
        document.getElementById('inputHomeCity').innerHTML = '<option value="">åŸå¸‚</option>';
        document.getElementById('inputResProv').value = "";
        document.getElementById('inputResCity').innerHTML = '<option value="">åŸå¸‚</option>';

        let node = findNode(familyData, id);
        if(node) {
            document.getElementById('inputGeneration').value = node.generation;
        }

        document.getElementById('editModal').style.display = 'flex';
    };

    function shiftGenerations(node) {
        if (!node) return;
        if (node.generation) {
            let genNum = parseInt(node.generation.replace(/[^0-9]/g, ''));
            if (!isNaN(genNum)) {
                node.generation = `ç¬¬${genNum + 1}ä»£`;
            }
        }
        if (node.children) {
            node.children.forEach(child => shiftGenerations(child));
        }
    }

    function drawGenerationGuides() {
        const guideContainer = document.getElementById('generation-guides');
        guideContainer.innerHTML = ''; 
        const cards = document.querySelectorAll('.member-card');
        if (cards.length === 0) return;
        const depthTops = {};
        let maxDepth = 0;
        cards.forEach(card => {
            const depth = parseInt(card.getAttribute('data-depth'));
            const rect = card.getBoundingClientRect();
            const containerRect = document.querySelector('.tree-wrapper').getBoundingClientRect();
            const relativeTop = rect.top - containerRect.top + document.querySelector('.tree-wrapper').scrollTop;
            if (!depthTops[depth]) depthTops[depth] = [];
            depthTops[depth].push(relativeTop);
            if (depth > maxDepth) maxDepth = depth;
        });
        const avgTops = {};
        for (let d = 1; d <= maxDepth; d++) {
            if (depthTops[d]) avgTops[d] = depthTops[d].reduce((a, b) => a + b, 0) / depthTops[d].length;
        }
        
        // ä»…ç»˜åˆ¶å·¦ä¾§æ ‡ç­¾ï¼Œä¸ç”»çº¿
        for (let d = 1; d <= maxDepth; d++) {
            const currentTop = avgTops[d];
            let labelText = `ç¬¬ ${d} ä»£`; 
            const sampleCard = document.querySelector(`.member-card[data-depth="${d}"]`);
            if (sampleCard) {
                const genSpan = sampleCard.querySelector('.card-gen');
                if (genSpan) labelText = genSpan.innerText;
            }
            const label = document.createElement('div');
            label.className = 'gen-label'; 
            label.innerText = labelText; 
            label.style.top = (currentTop + 10) + 'px'; 
            guideContainer.appendChild(label);
        }
    }
    window.addEventListener('resize', drawGenerationGuides);


    // --- å¼¹çª—é€»è¾‘ ---
    window.openViewModal = function(id) {
        let node = findNode(familyData, id);
        if (!node) return;
        currentActiveId = id;

        document.getElementById('viewName').innerText = node.name;
        document.getElementById('viewGen').innerText = node.generation || "æœªå¡«å†™";
        document.getElementById('viewBirth').innerText = formatDateCN(node.birthDate) || "æœªå¡«å†™";
        document.getElementById('viewBio').innerText = node.bio || "æš‚æ— è¯¦ç»†ä»‹ç»";
        
        let hometown = (node.hometownProv || "") + (node.hometownCity ? " - " + node.hometownCity : "");
        document.getElementById('viewHometown').innerText = hometown || "æœªå¡«å†™";
        
        let residence = (node.residenceProv || "") + (node.residenceCity ? " - " + node.residenceCity : "");
        document.getElementById('viewResidence').innerText = residence || "æœªå¡«å†™";

        const actionButtons = document.getElementById('viewActionButtons');
        if (isEditMode) {
            actionButtons.style.display = 'flex';
            if (id === familyData.id) {
                 document.getElementById('btnDeleteMember').style.display = 'none';
            } else {
                 document.getElementById('btnDeleteMember').style.display = 'inline-block';
            }
        } else {
            actionButtons.style.display = 'none';
        }
        document.getElementById('viewModal').style.display = 'flex';
    };

    window.switchToEditMode = function() {
        let node = findNode(familyData, currentActiveId);
        if (!node) return;
        isAddingNew = false;
        isInsertingParent = false;
        document.getElementById('viewModal').style.display = 'none';
        document.getElementById('editModalTitle').innerText = "ç¼–è¾‘æˆå‘˜ä¿¡æ¯";
        
        document.getElementById('inputName').value = node.name;
        document.getElementById('inputGeneration').value = node.generation || "ç¬¬1ä»£"; 
        document.getElementById('inputBirth').value = node.birthDate || "";
        document.getElementById('inputBio').value = node.bio || "";

        document.getElementById('inputHomeProv').value = node.hometownProv || "";
        updateCityOptions('inputHomeProv', 'inputHomeCity', node.hometownCity); 

        document.getElementById('inputResProv').value = node.residenceProv || "";
        updateCityOptions('inputResProv', 'inputResCity', node.residenceCity);

        document.getElementById('editModal').style.display = 'flex';
    };

    window.addMemberFromModal = function() {
        isAddingNew = true;
        isInsertingParent = false;
        document.getElementById('viewModal').style.display = 'none';
        document.getElementById('editModalTitle').innerText = "æ–°å¢å®¶åº­æˆå‘˜";
        
        document.getElementById('inputName').value = "";
        document.getElementById('inputBirth').value = "";
        document.getElementById('inputBio').value = "";
        document.getElementById('inputHomeProv').value = "";
        document.getElementById('inputHomeCity').innerHTML = '<option value="">åŸå¸‚</option>';
        document.getElementById('inputResProv').value = "";
        document.getElementById('inputResCity').innerHTML = '<option value="">åŸå¸‚</option>';

        let parent = findNode(familyData, currentActiveId);
        if (parent && parent.generation) {
            let genNum = parseInt(parent.generation.replace(/[^0-9]/g, ''));
            if (!isNaN(genNum)) {
                document.getElementById('inputGeneration').value = `ç¬¬${genNum + 1}ä»£`;
            } else {
                document.getElementById('inputGeneration').value = "ç¬¬1ä»£";
            }
        }
        document.getElementById('editModal').style.display = 'flex';
    }

    window.closeAllModals = function(e) {
        if (!e || e.target === document.getElementById('viewModal') || e.target === document.getElementById('editModal') || !e.target) {
            document.getElementById('viewModal').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
        }
    };

    window.saveMemberData = function() {
        let name = document.getElementById('inputName').value;
        let generation = document.getElementById('inputGeneration').value;
        let birth = document.getElementById('inputBirth').value;
        let bio = document.getElementById('inputBio').value;
        let hProv = document.getElementById('inputHomeProv').value;
        let hCity = document.getElementById('inputHomeCity').value;
        let rProv = document.getElementById('inputResProv').value;
        let rCity = document.getElementById('inputResCity').value;

        if (!name) { alert("å§“åä¸èƒ½ä¸ºç©ºï¼"); return; }

        let dataToUpdate = {
            name: name,
            generation: generation,
            birthDate: birth,
            bio: bio,
            hometownProv: hProv,
            hometownCity: hCity,
            residenceProv: rProv,
            residenceCity: rCity
        };

        if (isInsertingParent) {
             let childNode = findNode(familyData, currentActiveId);
             let parentNode = findParent(familyData, currentActiveId);
             
             if (childNode && parentNode) {
                 let idx = parentNode.children.findIndex(c => c.id === childNode.id);
                 if (idx > -1) {
                     parentNode.children.splice(idx, 1);
                     let newId = nextId++;
                     let newParent = Object.assign({ id: newId, children: [childNode] }, dataToUpdate);
                     parentNode.children.push(newParent); 
                     shiftGenerations(childNode);
                     saveToLocal();
                     refreshView();
                 }
             }
             document.getElementById('editModal').style.display = 'none';
        }
        else if (isAddingNew) {
            let parent = findNode(familyData, currentActiveId);
            if (parent) {
                let newId = nextId++;
                let newMember = Object.assign({ id: newId, children: [] }, dataToUpdate);
                if (!parent.children) parent.children = [];
                parent.children.push(newMember);
                saveToLocal();
                refreshView();
                document.getElementById('editModal').style.display = 'none';
            }
        } 
        else {
            let node = findNode(familyData, currentActiveId);
            if (node) {
                Object.assign(node, dataToUpdate); 
                saveToLocal();
                refreshView();
                document.getElementById('editModal').style.display = 'none';
            }
        }
    };

    window.handleDelete = function() {
        if (currentActiveId === 1) return;
        if(!confirm("ç¡®å®šè¦åˆ é™¤æ­¤äººï¼ˆåŒ…æ‹¬æ‰€æœ‰åä»£ï¼‰å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) return;
        deleteNodeRecursive(familyData, currentActiveId);
        saveToLocal();
        refreshView();
        closeAllModals(); 
    };

    function deleteNodeRecursive(parent, childId) {
        if (parent.children) {
            const index = parent.children.findIndex(c => c.id === childId);
            if (index > -1) {
                parent.children.splice(index, 1);
                return true;
            }
            for (let child of parent.children) {
                if (deleteNodeRecursive(child, childId)) return true;
            }
        }
        return false;
    }

    window.downloadData = function() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({data: familyData, nextId: nextId}, null, 2));
        const link = document.createElement('a');
        link.href = dataStr; link.download = "å²³é£å®¶è°±æ•°æ®.json";
        link.click();
    };

    window.importData = function(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const parsed = JSON.parse(e.target.result);
                if(parsed.data) {
                    if(confirm("ç¡®è®¤å¯¼å…¥ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ã€‚")) {
                        familyData = parsed.data;
                        nextId = parsed.nextId || 100;
                        saveToLocal();
                        initData();
                    }
                }
            } catch(err) { alert("æ–‡ä»¶æ— æ•ˆ"); }
            input.value = '';
        };
        reader.readAsText(file);
    };

    initData();

</script>

</body>
</html>